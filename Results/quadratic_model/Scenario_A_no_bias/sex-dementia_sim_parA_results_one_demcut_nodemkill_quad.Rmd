---
title: "Simulation Scenario A:  No bias anticipated"
subtitle: "One dementia cut point; no effect of dementia on survival; quadratic cognitive trajectories"
output: 
  bookdown::html_document2:
    fig_caption: TRUE
    table_caption: TRUE
    theme: yeti
    toc: TRUE
    toc_float: 
      collapsed: FALSE
    toc_depth: 2
bibliography: sex-dementia_sim_bib.bib 
csl: ieee-with-url.csl
header-includes: 
  - \usepackage{floatrow}
  - \floatsetup[figure]{capposition=top}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning=FALSE)
```

```{r Pacman statement}
if (!require("pacman")) 
  install.packages("pacman", repos = 'http://cran.us.r-project.org')

p_load("bookdown", "here", "tidyverse", "knitr", "kableExtra", "magrittr", 
       "reshape2", "survival")

options(digits = 5)
options(scipen = 999)
```

```{r Seed setting}
set.seed(03122019)
```

```{r Sourcing scripts}
source(here("RScripts", "dementia_incidence_ACT.R"))
source(here("RScripts", "US_life_table_calcs.R"))
source(here("RScripts", "quadratic_model", 
       "sex-dementia_sim_parA_onedemcut_nodemkill_male_AllDem_quad.R"))
source(here("RScripts", "quadratic_model", "variable_names_quad.R"))
```

```{r Loading data, eval = TRUE}
#Life table data
US_MF <- read_csv(here("Data", "US_cohort_table_white_MF_calcs.csv"), 
                           col_names = TRUE) %>% filter(Age < 100 & Age >= 50)
US_M <- read_csv(here("Data", "US_cohort_table_white_M_calcs.csv"), 
                          col_names = TRUE) %>% filter(Age < 100 & Age >= 50)
US_F <- read_csv(here("Data", "US_cohort_table_white_F_calcs.csv"), 
                          col_names = TRUE) %>% filter(Age < 100 & Age >= 50)

#One simulation run
dataset <- 
  readRDS(here(
    "Data", "quadratic_model", "dataset_A_male_AllDem_500000_20191118")) %>% 
  as.data.frame()

#Data Analyses
sim_results <-
  read_csv(here("Results", "quadratic_model", "Scenario_A_no_bias", 
                "sim_A_male_AllDem_1000_20191118.csv")) 


sim_results_65_plus <- sim_results %>% 
  dplyr::select(-one_of(variable_names$logIRR_varnames[1:3])) %>%
  dplyr::select(-one_of(variable_names$logIRR_95CI_Lower_varnames[1:3])) %>% 
  dplyr::select(-one_of(variable_names$logIRR_95CI_Upper_varnames[1:3])) %>% 
  dplyr::select(-one_of(variable_names$logIRR_95CI_Coverage_varnames[1:3])) %>% 
  dplyr::select(-one_of(variable_names$logIRR_SE_varnames[1:3])) %>% 
  dplyr::select(-one_of(variable_names_1year$logIRR_varnames[1:15])) %>%
  dplyr::select(
    -one_of(variable_names_1year$logIRR_95CI_Lower_varnames[1:15])) %>% 
  dplyr::select(
    -one_of(variable_names_1year$logIRR_95CI_Upper_varnames[1:15])) %>% 
  dplyr::select(
    -one_of(variable_names_1year$logIRR_95CI_Coverage_varnames[1:15])) %>% 
  dplyr::select(-one_of(variable_names_1year$logIRR_SE_varnames[1:15]))
  
                        
                        
#mean_sim_results <- colMeans(sim_results)
mean_sim_results <- colMeans(sim_results_65_plus)

#sd_sim_results <- apply(sim_results, 2, sd)
```

```{r Column names}
#Interval labels i.e. [50, 55)
age_labels <- tibble("Age" = c("Age ", rep("", (num_tests - 1))), 
                     "Age_rep" = rep("Age ", num_tests),
                     "left_brack" = "[", 
                     "interval_ages" = na.omit(variable_names$interval_ages), 
                     "right_pren" = ")") %>%
  unite("formatted_age_intervals", 
        c("Age", "left_brack", "interval_ages", "right_pren"), sep = "", 
        remove = FALSE) %>%
  unite("Age_interval", 
        c("Age_rep", "left_brack", "interval_ages", "right_pren"), sep = "", 
        remove = FALSE)
```

<br>
<br>

```{r DAG, fig.align="center", out.width="75%"}
knitr::include_graphics(here("DAGs", "sex-dem_sim_parA_DAG_UonInt_only.png"))
```
<br>

In this scenario, sex influences survival while U influences level of cognitive function at age 50 (the intercept in our case) and dementia incidence.  The dotted line from U to survival represents the fact that in this causal structure, U does not influence survival; but the effects of U on survival will be added in future scenarios consistent with collider bias.

<br>

#  Description of Hypothetical Cohort Study 
This is a hypothetical cohort study of sex/gender differences in dementia incidence.  The hypothetical cohort included 100,000 men and women recruited at age 50 years and followed for dementia incidence until age 95 (45 years).  To quantify the extent to which selective survival could plausibly explain higher dementia incidence in women compared to men at older ages, we generated the data assuming no effect of sex/gender on late-life cognitive trajectories and dementia incidence. Thus, associations between sex/gender and dementia incidence reflect survival bias in our simulations.  

## Survival 
We are now calibrating dementia incidence to the US based ACT study[@Tom2015], thus we are using US life table data. Looking at baseline age data and taking a weighted average, it seems like the 1919-1921 birth cohort is appropriate for calibration.  

```{r HR-Plots, fig.align = "center", out.width = "75%", fig.cap = "Female:Male mortality hazard ratios calculated from US life tables."}
Hratio_US <- US_F$Haz/US_M$Haz %>%
  as.data.frame() %>% set_colnames("US") 

HR_plot_data <- Hratio_US %>%
  mutate("Age" = seq(50, 95, by = 5)) %>%
  gather("US", key = "Country", value = "HR") %>% 
  mutate_at("Country", as.factor)

ggplot(HR_plot_data, aes(Age, HR)) + 
  geom_line(aes(color = Country, group = Country), size = 1.25, alpha = 0.6) +
  labs(y = "Mortality Hazard Ratio (Women:Men)", x = "Age", 
       color = "") + ylim(0, 1) + theme_minimal() + 
  scale_y_continuous(breaks = seq(0.75, 1, 0.01)) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  ggtitle("1919-1921 Birth Cohort")
```

Sex/Gender-specific survival distributions from ages 50-95 years were generated to match survival distributions from the US cohort life table for whites (1919-1921 birth cohort).  For individual $i$ in time interval $j$, time to death was generated as a random variable drawn from an exponential survival distribution based on the hazard function in Equation \@ref(eq:mort-hazard). 

\begin{equation}
h_{\text{death}_{ij}}(t) =  \lambda_{j}\exp\{\gamma_{1j}\text{female}_i + \gamma_2U_i + \gamma_3U_i \times \text{male}_i\},
(\#eq:mort-hazard)
\end{equation}

where $U_i \sim N(0, 1)$.  The values for each of the coefficients in the hazard function are displayed in Table \@ref(tab:mort-haz-coeff).  In the table, $\gamma_{10}-\gamma_{19}$ represent the age-specific effect of being a woman on mortality.  Note that $\gamma_2-\gamma_3$ are set to 0 in Simulation Scenario A signifying that in this scenario, there is no effect of U on mortality.

```{r mort-haz-coeff}
coeff_table <- 
  tibble("Simulation Scenario" = rep("", 11), 
         "A" = c(g1, g2, g3)) %>% 
  t() %>% 
  set_colnames(c("$\\gamma_{11}$", "$\\gamma_{12}$", 
                 "$\\gamma_{13}$", "$\\gamma_{14}$", "$\\gamma_{15}$", 
                 "$\\gamma_{16}$", "$\\gamma_{17}$", "$\\gamma_{18}$",
                 "$\\gamma_{19}$", "$\\gamma_{2}$", "$\\gamma_{3}$"))

kable(coeff_table, escape = FALSE, 
      caption = "Coefficients used to generate mortality hazard") %>% 
  kable_styling()
```

Using R's optim function [@Roptim], we solved for the $\lambda_j$ values and $\gamma_{1j}$ (baseline mortality hazard for men in each 5-year age band and the effect of being a woman on mortality, respectively) in our hazard function so that conditional probabilities of survival (survival to age x + 5 conditional on survival to age x) in our simulated data closely matched those calculated from the US cohort life table.  

Table \@ref(tab:Lambda-values) shows the computed values of $\lambda_j$ for our hazard function. Figure \@ref(fig:survival-plots) compares the simulated cumulative survival probabilities from age 50 years based on these $\lambda_j$, i.e., the probability of surviving to each age conditional on survival to age 50, with cumulative survival probabilites calculated from the US life tables. Figure \@ref(fig:cp-survival-plots) compares the simulated conditional survival probabilities from age 50 years based on these $\lambda_j$, with conditional survival probabilites calculated from the US life tables.  Figure \@ref(fig:mort-HR-plots) compares the simulated mortality hazard ratios from ages 50+ to those calculated from life tables.  Both the survival probabilities calculated from simulated data and the modeled mortality hazard ratios were averaged over `r runs` iterations of sample generation.  The average of the mortality hazard ratios was computed by first taking the mean of the observed age-specific ln(mortality HR) across the `r runs` simulated samples and then exponentiating.  Average cumulative mortality  = `r as.numeric(round((1 - mean_sim_results["p_alive_95"])*100, 1))`% across the `r runs` simulated samples.

<br>

```{r Lambda-values}
lambda_values <- lambda %>% t() %>% as.data.frame() %>%
  set_colnames(age_labels$formatted_age_intervals) %>% set_rownames("Lambda")

kable(lambda_values, 
      caption = "Baseline hazard for men in each 5-year age band") %>% kable_styling()
```

<br>

```{r Survival plot data}
all_cp_survival <- 
  c(1, mean_sim_results[na.omit(variable_names$p_alive_varnames)])
female_cp_survival <- 
  c(1, mean_sim_results[na.omit(variable_names$p_alive_females_varnames)])
male_cp_survival <- 
  c(1, mean_sim_results[na.omit(variable_names$p_alive_males_varnames)])

#Data that we need
US_MF_survival <- US_MF %>% filter(Age >= 50 & Age <= 95)
US_M_survival <- US_M %>% filter(Age >= 50 & Age <= 95)
US_F_survival <- US_F %>% filter(Age >= 50 & Age <= 95)

plot_data <- tibble("age" = seq(50, 95, by = 5), 
                    "pub_all_survival" = all_life_US$cum_surv_cond50, 
                    "pub_female_survival" = female_life_US$cum_surv_cond50, 
                    "pub_male_survival" = male_life_US$cum_surv_cond50, 
                    "cohort_all_survival" = all_cp_survival, 
                    "cohort_female_survival" = female_cp_survival, 
                    "cohort_male_survival" = male_cp_survival) 
```

```{r survival-plots, fig.show="hold", out.width="50%", fig.cap=paste("Average simulated cumulative survival probabilites from age 50 years across", runs, "iterations of sample generation")}
#Female survival plot
plot_data_female <- plot_data %>% dplyr::select(age, contains("female")) %>%
  gather(key = key, value = value, 
         c("pub_female_survival", "cohort_female_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_female_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_female, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Women", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal() 
#+ theme(text = element_text(size = 40))

#Male survival plot
plot_data_Male <- plot_data %>% dplyr::select(age, contains("Male")) %>%
  gather(key = key, value = value, 
         c("pub_male_survival", "cohort_male_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_male_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_Male, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Men", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal() 
#+ theme(text = element_text(size = 40))

#All survival plot
plot_data_all <- plot_data %>% dplyr::select(age, contains("all")) %>%
  gather(key = key, value = value, 
         c("pub_all_survival", "cohort_all_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_all_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_all, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Whole Population", 
       y = "Cumulative Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal()
```


```{r cp-survival-plots, fig.show="hold", out.width="50%", fig.cap=paste("Average simulated conditional survival probabilites from age 50 years across", runs, "iterations of sample generation"), eval = FALSE}
#Female survival plot
plot_data_cp_female <- cp_plot_data %>% 
  dplyr::select(age, contains("female")) %>%
  gather(key = key, value = value, 
         c("pub_female_cp_survival", "cohort_female_cp_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_female_cp_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_cp_female, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Women", 
       y = "Conditional Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal() 
#+ theme(text = element_text(size = 40))

#Male survival plot
plot_data_cp_male <- cp_plot_data %>% 
  dplyr::select(age, contains("male")) %>%
  gather(key = key, value = value, 
         c("pub_male_cp_survival", "cohort_male_cp_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_male_cp_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_cp_male, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Men", 
       y = "Conditional Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal() 
#+ theme(text = element_text(size = 40))

#All survival plot
plot_data_cp_all <- cp_plot_data %>% 
  dplyr::select(age, contains("all")) %>%
  gather(key = key, value = value, 
         c("pub_all_cp_survival", "cohort_all_cp_survival")) %>% 
  separate(col = key, into = c("type", "key"), sep = "_all_cp_survival", 
           remove = FALSE) %>% 
  mutate("Data Type" = if_else(type == "pub", "Published", "Simulated"))

ggplot(plot_data_cp_all, 
       aes(age, value, group = `Data Type`, color = `Data Type`)) + 
  geom_line(size = 1.25) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  labs(title = "Whole Population", 
       y = "Conditional Survival Probability from age 50", 
       x = "Age") + 
  theme_minimal() 
#+ theme(text = element_text(size = 40))
```

<br>

```{r mort-HR-plots, fig.align="center", out.width = "75%", fig.cap=paste("Average simulated mortality hazard ratios for age 50+ across", runs, "simulation runs. Ages on the x-axis represent the age at the start of interval, i.e. 50 represents the mortality HR for the interval [50, 55).")}

published_HR <- Hratio_US[-1, ] %>%
  as.data.frame() %>% set_colnames("Published Mortality HR")

simulated_HRs <- 
  exp(mean_sim_results[na.omit(variable_names$mortality_logHR_varnames)]) %>%
  as.data.frame() %>% set_colnames("Modeled Mortality HR")

pub_sim_HR_data_cox <- 
  cbind(published_HR, simulated_HRs) %>% 
  mutate("Age" = seq(50, 90, by = 5)) %>%
  gather(c("Published Mortality HR", "Modeled Mortality HR"), 
         key = "Data Type", value = "HR") %>% 
  mutate_at("Data Type", as.factor)
pub_sim_HR_data_cox$`Data Type` <- fct_relevel(pub_sim_HR_data_cox$`Data Type`,
                                               "Modeled Mortality HR",
                                               after = 1)

ggplot(pub_sim_HR_data_cox, aes(Age, HR)) + 
  geom_point(aes(color = `Data Type`, group = `Data Type`), size = 1.75) + 
  geom_line(aes(color = `Data Type`, group = `Data Type`), size = 1.25, 
            alpha = 0.6) + 
  scale_x_continuous(breaks = seq(50, 95, 5)) +
  #ylim(0, 1) +
  #scale_y_continuous(breaks = seq(0, 1, 0.05)) +
  labs(y = "Mortality Hazard Ratio (Women:Men)", x = "Age", 
       color = "") + theme_minimal() + 
  #theme(text = element_text(size = 40)) + 
  ggtitle("Mortality Hazard Ratios")
```
 
## Survival Sanity Check Calculations

```{r Numerical-survival-checks}
female_surv_check <- cbind(plot_data$pub_female_survival, 
                           plot_data$cohort_female_survival) %>% 
  as.data.frame() %>% set_colnames(c("Published", "Simulated")) %>% 
  mutate("Difference (Sim - Pub)" = Simulated - Published) %>% t() %>% 
  as.data.frame() %>%
  set_colnames(c("Age 50", age_labels$formatted_age_intervals))

kable(female_surv_check, 
      caption = 
        "Cumulative survival for women conditional on survival to age 50") %>% kable_styling()

male_surv_check <- cbind(plot_data$pub_male_survival, 
                         plot_data$cohort_male_survival) %>% 
  as.data.frame() %>% set_colnames(c("Published", "Simulated")) %>% 
  mutate("Difference (Sim - Pub)" = Simulated - Published) %>% t() %>% 
  as.data.frame() %>%
  set_colnames(c("Age 50", age_labels$formatted_age_intervals))

kable(male_surv_check, 
      caption = 
        "Cumulative survival for men conditional on survival to age 50") %>% kable_styling()

HR_check <- cbind(published_HR, simulated_HRs) %>% 
  as.data.frame() %>% set_colnames(c("Published", "Simulated")) %>% 
  mutate("Difference (Sim - Pub)" = Simulated - Published) %>% t() %>% 
  as.data.frame() %>%
  set_colnames(c(age_labels$formatted_age_intervals))

kable(HR_check, 
      caption = "HRs (Women:Men)") %>% kable_styling()
```

## Dementia

Dementia incidence was generated based on cognitive function using an age-constant cut point for "dementia". The model for generating $C_{ij}$ is displayed in \@ref(eq:Cij)

\begin{equation}
C_{ij}(t) = \beta_{00} + \zeta_{0i} + \beta_{01}\text{sex}_i + \beta_{02}U_i + \varepsilon_{i} + (\beta_{10} + \zeta_{1i} + \beta_{11}\text{sex}_i + \beta_{12}U_i)t + (\beta_{20} + \zeta_{2i} + \beta_{21}\text{sex}_i + \beta_{22}U_i)t^2,
(\#eq:Cij)
\end{equation}

where $U_i \sim N(0,1)$. Here, $\varepsilon_{ij} \sim N(0, \sigma^2_{\varepsilon})$ represents unexplained variation in $C_{ij}$.

Time to dementia is calculated based on when the individual fell below the age-constant dementia cut point.

The chosen dementia cut point and its associated percentile for each 5-year age band are displayed in Table \@ref(tab:dem-cuts).  Percentile values represent the proportion of the living, dementia-free cohort that will be diagnosed with dementia by the end of the time interval. There was no interval censoring included in our simulations; age at dementia diagnosis was based on the age at which a participant's cognitive function fell below the diagnostic threshold for the 5-year age band.  Age-specific dementia incidence rates for ages 65-95 were generated to match male AD incidence rates from the ACT study.  The data were generated assuming no effect of sex/gender on late-life cognitive trajectories and dementia incidence, thus associations between sex/gender and dementia incidence reflect survival bias in our simulations.   


```{r dem-cuts}
cutoffs <- rep(dem_cut, 10)
Cij_data <- dataset %>% dplyr::select(variable_names$Cij_varnames)
means <- Cij_data %>% map_dbl(~ mean(., na.rm = TRUE))
SDs <- Cij_data %>% map_dbl(~ sd(., na.rm = TRUE))

percentile <- vector(length = 10)
for(i in 1:length(cutoffs)){
  percentile[i] <- pnorm(cutoffs[i], mean = means[i], sd = SDs[i])
}

percentile_table <- rbind(cutoffs, percentile)
colnames(percentile_table) <- c("Age <50", "[50, 55)",  age_labels$formatted_age_intervals[-1])
rownames(percentile_table) <- c("Dementia Cutoff", "Percentile")
kable(percentile_table, 
      caption = "Dementia cut points and associated percentiles. 
      The percentile is the proportion of susceptible that will be diagnosed 
      with dementia.") %>% 
  kable_styling()
```

<br>

Average dementia incidence rates per 1000 person years across `r runs` simulated samples are displayed in Table \@ref(tab:dem-inc-rates). The dementia incidence rates from the ACT study, used as reference, are displayed in the first line of the table. The average dementia hazard ratios across `r runs` simulated scenarios are displayed in Table \@ref(tab:hr-table), and the average incidence rate ratios are displayed in Table \@ref(tab:IRR-table).  In both cases, ratios are presented as women:men.

<br>

```{r dem-inc-rates}
dem_table <- 
  tibble("ACT" = c(" ", " ", " ", 
                       round(ACT_inc_rates$Male_All_Dementia_1000PY, 3)), 
         "Simulation Scenario A" = " ", 
         "W" = as.vector(
           mean_sim_results[
             na.omit(variable_names$dem_inc_rate_females_varnames)]), 
         "M" = as.vector(
           mean_sim_results[
             na.omit(variable_names$dem_inc_rate_males_varnames)]),
         "Combined" = 
           as.vector(
             mean_sim_results[
               na.omit(variable_names$dem_inc_rate_varnames)])) %>% 
           t() %>% set_colnames(age_labels$formatted_age_intervals)

kable(dem_table, caption = 
"Dementia incidence rates. Source: Characterization of Dementia and Alzheimer's Disease in an Older Population. (Tom et al 2015); Table 2.") %>% kable_styling()
```

<br>

```{r hr-table, eval = FALSE}
hr_table <- 
  tibble("Simulation Scenario A" = " ", 
         "HR" = exp(
           mean_sim_results[
             na.omit(variable_names$dementia_logHR_varnames)])) %>% 
  t() %>% set_colnames(age_labels$formatted_age_intervals)

kable(hr_table, caption = 
        paste("Average hazard ratios for dementia 
              (exponentiated mean of the observed ln(dementia HR) across", runs, 
              "simulated samples).")) %>% 
  kable_styling()
```

<br>

```{r IRR-table}
IRR_table <- 
  tibble("Simulation Scenario A" = " ", 
         "IRR" = exp(
           mean_sim_results[na.omit(variable_names$logIRR_varnames)])) %>% 
  t() %>% set_colnames(age_labels$formatted_age_intervals)

kable(IRR_table, caption = paste("Average incidence rate ratios for dementia (exponentiated mean of the observed ln(dementia IRR) across", runs, "simulated samples).")) %>% kable_styling()
```

<br>

# Some results from one simulated sample

##  Cognitive Trajectories

```{r cog-trajectories, fig.align="center", fig.cap="Mean cognitive trajectories overlayed on a random sample of 10 individual's trajectories."}
Cij_check <- dataset %>% 
  dplyr::select("female", variable_names$Cij_varnames)

#Getting mean Cij by sex
female_meanCij<- Cij_check %>% filter(female == 1) %>% colMeans(., na.rm = TRUE)
male_mean_Cij <- Cij_check %>% filter(female == 0) %>% colMeans(., na.rm = TRUE)

#Checking the mean slopes by sex
slopes_check <- dataset %>% dplyr::select(female, contains("slope"))
female_slopes_check <- slopes_check %>% filter(female == 1) %>% colMeans()
male_slopes_check <- slopes_check %>% filter(female == 0) %>% colMeans()

female_mean_plot <- tibble("Age" = c(seq(50, 95, by = 5)), 
                           "variable" = "Women", 
                           "value" = female_meanCij[-1])

male_mean_plot <- tibble("Age" = seq(50, 95, by = 5), 
                         "variable" = "Men", 
                         "value" = male_mean_Cij[-1])

Cij_plot_data <- dataset %>% 
  dplyr::select("id", "female", variable_names$Cij_varnames, "survtime", 
                "last_Cij") %>% sample_n(100) %>% 
  mutate("Age" = survtime + 50) %>% 
  dplyr::select(-c(survtime, female)) %>% 
  set_colnames(c("id", variable_names$Cij_varnames, "Cij", "Age")) 


#Plot data
samp_Cij <- Cij_plot_data[, c("id", variable_names$Cij_varnames)] %>%
  set_colnames(c("id", seq(50, 95, by = 5))) %>% 
  gather(as.character(seq(50, 95, by = 5)), key = "Age", value = "Cij") %>% 
  mutate_at("Age", as.numeric) %>% 
  rbind(., Cij_plot_data[, c("id", "Age", "Cij")]) %>% 
  set_colnames(c("variable", "Age", "value")) %>% 
  rbind(., female_mean_plot) %>% 
  rbind(., male_mean_plot)

#---- Plot a sample of Cij ----
#Creating a plot with random sample in the background
ggplot(samp_Cij, aes(Age, value)) + 
  geom_line(data = 
              subset(samp_Cij, variable != "Women" & variable != "Men"), 
            aes(group = variable), color = "gray") +
  geom_line(data = subset(samp_Cij, variable == "Women"), 
            aes(color = variable), size = 1.25) + 
  geom_line(data = subset(samp_Cij, variable == "Men"), 
            aes(color = variable), size = 1.25, alpha = 0.6) + 
  geom_hline(yintercept = dem_cut, size = 1.25) + 
  labs(y = "Cognitive Function", 
       x = "Age", 
       color = "Mean Cognitive \n Function") + 
  scale_x_continuous(breaks = seq(50, 95, 5)) + 
  ggtitle("Mean Cognitive Trajectories") +
  theme_minimal() +  
  #theme(text = element_text(size = 28)) + 
  coord_cartesian(ylim = c(-10, 10)) + 
  #guides(color = guide_legend(reverse = TRUE)) +
  geom_hline(yintercept = dem_cut) 
```

<br>
**These values will eventually just be tables in the parameters for the $C_{ij}$ model.**

```{r mean-slopes, eval = FALSE}
Cij_check <- Cij_check <- 
  colMeans(dataset[, variable_names$Cij_varnames], na.rm = TRUE)

mean_slopes_observed <- vector(length = length(visit_times) - 1)

for(i in 1:length(mean_slopes_observed)){
  mean_slopes_observed[i] <- (Cij_check[i + 1] - Cij_check[i])/int_time
}

mean_slopes_observed %<>%
  as.data.frame() %>% t() %>%
  set_colnames(na.omit(variable_names$interval_ages)) %>% set_rownames("")

kable(mean_slopes_observed, caption = "Observed mean slopes at each interval.  
      Note that the mean slope (rate of cognitive change) 
      becomes more negative with age.") %>% kable_styling()
```

<br>

## Dementia Cases

```{r dem-cases-plot, fig.align="center", fig.cap="Dementia cases by age from one simulated sample. Incident cases at each age are plotted in blue. (Note that the y-axis differs across age bands because of the large difference in number of live people across age bins.)"}
cutoffs <- rep(dem_cut, 10)
Cij_data <- dataset %>% dplyr::select(variable_names$Cij_varnames)
dem_wave_data <- dataset %>% dplyr::select(dem_wave)
Cij_indicators <- matrix(0, nrow = nrow(Cij_data), ncol = ncol(Cij_data))
for(i in 1:nrow(dem_wave_data)){
  if(!is.na(dem_wave_data[i, ])){
    slot <- dem_wave_data[i, ]
    Cij_indicators[i, (slot + 1)] <- 1
  }
}
indicators <- unlist(as.data.frame(Cij_indicators))

hists <- Cij_data %>% 
  set_colnames(c("Age 50", age_labels$Age_interval)) %>% 
  gather() %>% 
  mutate_at("key", as.factor) 
hists$indicators <- indicators
hists$key <- fct_relevel(hists$key, "Age 50")

z <- data.frame(key = levels(hists$key), 
                cutoff = cutoffs)
  
hists %>% ggplot(aes(value)) + 
  geom_vline(data = z, aes(xintercept = cutoff), color = "black", size = 1) + 
  geom_histogram(fill = "gray", alpha = 0.6) + 
  geom_histogram(data = hists %>% filter(indicators == 1), fill = "dodgerblue2", 
                 alpha = 0.6) + 
  labs(title = "Dementia Cases by Age Band", 
       x = "Cognitive Level", 
       y = "Live People") + 
  facet_wrap(~ key, scales = "free") + 
  #theme(text = element_text(size = 28)) +
  xlim(-30, 3.5) + theme_minimal()  
```
```{r Random-vs-trajectory-dem}
dem_both <- ifelse(dataset$dem_Cij == 1 & dataset$dem_random == 1, 1, 0)
```

Number of people with random/shock dementia:  `r sum(dataset$dem_random)` (`r mean(dataset$dem_random)`)  
Number of people with trajectory dementia:  `r sum(dataset$dem_Cij)` (`r mean(dataset$dem_Cij)`)  
Number of people with both types: `r sum(dem_both)` (`r mean(dem_both)`)

<br>

```{r dem-prev, eval = FALSE}
dem_prev <- dataset %>% dplyr::select(variable_names$dem_varnames) %>% 
  colMeans(na.rm = TRUE) %>% as.data.frame() %>% t() %>%
  set_colnames(c("Age 50", "[50-55)", 
                 age_labels$formatted_age_intervals[-1])) %>% 
  set_rownames("Prevalence")

kable(dem_prev, 
      caption = "Prevalence of dementia by age for one simulated sample. 
      Estimating this is not our primary goal, but we thought this might be 
      another good sanity check.  We expect that these numbers are higher than 
      what they should be because in this scenario, 
      dementia does not kill anyone. ") %>% kable_styling()
```

## Distributions of U

```{r U-dists, fig.align="center", fig.cap="Distribution of U by age and sex/gender in one simulated sample."}
mean_U <- rep(0, 10)

dem_data <- dataset %>% 
  dplyr::select(c("female", "U", "death0", 
                  head(variable_names$deathij_varnames, -1))) %>%
  mutate("Sex" = if_else(female == 0, "Men", "Women")) %>% 
  dplyr::select(-one_of("female")) %>% 
  dplyr::select("U", "death0", everything()) %>% 
  set_colnames(c("U", "Age 50", age_labels$Age_interval, 
                 "Sex/Gender")) %>%
  gather(contains("Age"), 
         key = "Age", value = "death_indicator") %>%
  filter(death_indicator == 0) %>% 
  mutate_at("Sex/Gender", as.factor)

dem_data$Age <- fct_relevel(dem_data$Age, "Age 50")
dem_data$`Sex/Gender` <- fct_relevel(dem_data$`Sex/Gender`, "Men")

y <- data.frame(key = levels(dem_data$Age), cutoff = mean_U)
  
dem_data %>% ggplot(aes(x = U)) + 
  geom_vline(data = y, aes(xintercept = 0), color = "black", size = 1) + 
  geom_histogram(data = dem_data %>% filter(`Sex/Gender` == "Women"), 
                 aes(y = ..density.., fill = "Women"),
                 binwidth = 0.01) +
  geom_histogram(data = dem_data %>% filter(`Sex/Gender` == "Men"), 
                 aes(y = ..density.., fill = "Men"), alpha = 0.5,
                 binwidth = 0.01) + 
  #xlim(-3, 3) + ylim(0, 0.6) + 
  labs(x = "U", 
       y = "Density") + 
  facet_wrap(~ Age, scales = "free") + theme_minimal() + 
  #theme(text = element_text(size = 20)) + 
  #guides(fill = guide_legend(reverse = TRUE)) + 
  theme(legend.title = element_text("Sex/Gender"))

#numerical summaries of U
mean_U_summary <- dem_data %>% group_by(`Sex/Gender`, Age) %>% 
  summarise_at("U", mean)

#plot of numerical summary
mean_U_summary$Age <- rep(seq(50, 95, by = 5), 2)
ggplot(aes(Age, U), data = mean_U_summary) + 
  geom_point(aes(colour = `Sex/Gender`)) + theme_minimal() + 
  geom_line(aes(color = `Sex/Gender`)) + 
  #theme(text = element_text(size = 22)) +
  ylab("Mean U") 
  
```

## Extra Sanity Check Calculations

```{r PY-by-sex}
py_by_sex <- dataset %>% group_by(female) %>% 
  dplyr::select(head(variable_names$contributed_varnames, -1)) %>% 
  summarise_all(~sum(., na.rm = TRUE)) %>% 
  mutate(Sex = case_when(female == 1 ~ "Female", 
                         TRUE ~ "Male")) %>% 
  dplyr::select(-one_of("female")) %>% 
  dplyr::select(Sex, everything()) %>% 
  set_colnames(c("Sex", age_labels$formatted_age_intervals))

kable(py_by_sex, caption = "Dementia-free person-years contributed to each 
      5-year age interval by sex from one simulated sample.") %>% 
  kable_styling()
```

<br>

```{r Dem-inc 5-year, eval = FALSE}
dem_inc_by_sex <- dataset %>%
  dplyr::select(female, dem_wave) %>% 
  mutate_at("dem_wave", as.factor) %>% 
  mutate(Sex = case_when(female == 1 ~ "Female", 
                         TRUE ~ "Male")) %>% 
  dplyr::select(Sex, dem_wave) %>% 
  group_by(Sex) %>%
  count(dem_wave) %>% 
  filter(dem_wave != "NA") %>% spread(key = Sex, value = n) %>% t() %>%
  set_rownames(c("Sex", "Female", "Male")) %>% 
  set_colnames(age_labels$formatted_age_intervals)
  
kable(dem_inc_by_sex[-1, ], caption =  "Number of incident dementia cases in 
      each 5-year age interval by sex in one simulated sample.") %>% 
  kable_styling()
```
```{r Dem-inc 1-year}
mean_results <- 
  mean_sim_results[variable_names_1year$inc_cases_males_varnames] %>% 
  as.data.frame() %>% cbind(seq(51, 95, by = 1)) %>%
  set_colnames(c("inc_cases", "age"))

ggplot(aes(age, inc_cases), data = mean_results) + 
  geom_point(color = "#00BFC4", size = 2) + theme_minimal() + 
  xlab("Age") + ylab("Incident Dementia Cases") + 
  ggtitle("Incident Dementia Cases by Age") + 
  scale_x_continuous(breaks = seq(50, 95, by = 5))
```


```{r Dem-inc rate 1-year}
mean_inc_rate <- 
  mean_sim_results[variable_names_1year$inc_cases_males_varnames]/
  mean_sim_results[variable_names_1year$PY_males_varnames] %>% 
  as.data.frame() 

mean_inc_rate %<>% cbind(., seq(51, 95, by = 1)) %>% 
  set_colnames(c("inc_rate", "age"))


ggplot(aes(age, inc_rate), data = mean_inc_rate) + 
  geom_point(color = "#00BFC4", size = 4) + theme_minimal() + 
  xlab("Age") + ylab("Dementia Incidence Rate") + 
  ggtitle("Annual Dementia Incidence Rates") + 
  scale_x_continuous(breaks = seq(50, 95, by = 5)) 
#+ theme(text = element_text(size = 28))
```

```{r Dem-inc rate 1-year by sex}
mean_inc_rate_males <- 
  mean_sim_results[variable_names_1year$inc_cases_males_varnames]/
  mean_sim_results[variable_names_1year$PY_males_varnames] %>% 
  as.data.frame() %>% set_colnames(c("Male"))

mean_inc_rate_females <- 
  mean_sim_results[variable_names_1year$inc_cases_females_varnames]/
  mean_sim_results[variable_names_1year$PY_females_varnames] %>% 
  as.data.frame() %>% set_colnames(c("Female"))

mean_inc_rate_by_sex <- cbind(mean_inc_rate_females, mean_inc_rate_males)
mean_inc_rate_by_sex %<>% cbind(., seq(51, 95, by = 1)) %>% 
  set_colnames(c("female", "male", "age")) %>% 
  gather(c("female", "male"), key = "Sex", value = "inc_rate")


ggplot(aes(age, inc_rate), data = mean_inc_rate_by_sex) + 
  geom_point(aes(color = Sex), size = 4) + theme_minimal() + 
  xlab("Age") + ylab("Dementia Incidence Rate") + 
  ggtitle("Annual Dementia Incidence Rates") + 
  scale_x_continuous(breaks = seq(50, 95, by = 5)) 
#+ theme(text = element_text(size = 28))

IRRs_by_year <- mean_inc_rate_females/mean_inc_rate_males
plot(IRRs_by_year$Female)
```

# References






